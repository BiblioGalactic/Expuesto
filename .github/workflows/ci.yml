# ============================================================
# üîÑ EXPUESTO ‚Äî CI/CD Pipeline
# ============================================================
# Validaci√≥n autom√°tica en cada push y pull request.
# Ejecuta: ShellCheck, pytest, y tests e2e.
# ============================================================
name: CI ‚Äî Validaci√≥n Expuesto

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üîç ShellCheck ‚Äî Lint de scripts bash
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Instalar ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Ejecutar ShellCheck en todos los .sh
        run: |
          ERRORS=0
          CHECKED=0
          while IFS= read -r -d '' script; do
            [[ "$script" == */.git/* ]] && continue
            [[ "$script" == */node_modules/* ]] && continue
            [[ "$script" == */venv/* ]] && continue
            CHECKED=$((CHECKED + 1))
            if ! shellcheck -S warning -e SC1091,SC2059,SC2086 "$script" 2>/dev/null; then
              echo "‚ùå FAIL: $script"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find . -name "*.sh" -type f -print0)
          echo "Revisados: $CHECKED | Errores: $ERRORS"
          exit "$ERRORS"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üêç Pytest ‚Äî Tests unitarios Python
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  pytest:
    name: Pytest ‚Äî bash-common.sh
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install pytest

      - name: Ejecutar tests unitarios
        run: pytest tests/python/ -v --tb=short

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üß™ E2E ‚Äî Tests de integraci√≥n
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  e2e:
    name: Tests E2E
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Tests de estructura del proyecto
        run: bash tests/e2e/test_project_structure.sh

      - name: Tests de sanitizaci√≥n
        run: bash tests/e2e/test_sanitization.sh

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ‚úÖ Validaci√≥n completa
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  validation-gate:
    name: Validaci√≥n Completa
    needs: [shellcheck, pytest, e2e]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Verificar resultados
        run: |
          if [[ "${{ needs.shellcheck.result }}" == "failure" ]] || \
             [[ "${{ needs.pytest.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e.result }}" == "failure" ]]; then
            echo "‚ùå Alg√∫n job fall√≥"
            exit 1
          fi
          echo "‚úÖ Todos los checks pasaron"
